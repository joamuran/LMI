# Conversió i adaptació de documents pe a l'intercanvi d'informació



## Per què convertir documents?

L'intercanvi d'informació, sovint necessita realitzar conversions de documents, per diferents motius, com puguen ser:

* **Compatibilitat entre sistemes**: Diferents aplicacions o plataformes poden utilitzar formats de fitxers propis, com XML, JSON, HTML, CSV, PDF, entre altres.

* **Interoperabilitat**: La conversió de documents permet que sistemes que utilitzen formats diferents puguin compartir informació de manera efectiva. Per exemple, convertir un document XML a HTML perquè siga visualitzat en una pàgina web.

* **Processament d’informació**: Moltes vegades, es necessita reformatejar o filtrar dades per al seu ús en diferents aplicacions, com informes o altres tipus de presentacions.

Les eines que veurem en aquest apartat permeten que la transformació d'un format a un altre sigui automàtica i eficient, garantint que la informació seguisca sent coherent i fiable durant el procés.

## Àmbits d’aplicació

La conversió de documents s'aplica en diversos àmbits on es requereix intercanvi d'informació, per exemple:

* **Intercanvi B2B (Business to Business)**: Empreses que intercanvien documents (com comandes, factures, inventaris) en formats estructurats com XML o EDI.

* **Integració entre sistemes**: Sistemes que utilitzen diferents estàndards de dades necessiten una conversió per poder compartir informació. Per exemple, una API que rep dades en JSON i les converteix a XML abans d'emmagatzemar-les en una base de dades.

* **Plataformes de contingut i presentació**: Convertir documents XML a formats presentables com HTML o PDF per a la visualització a la web o per a la impressió d'informes.

## Tecnologies implicades i mode de funcionament

Per a la conversió de documents, una de les tecnologies clau és **XSLT** (Extensible Stylesheet Language Transformations), que permet transformar documents XML a altres formats com HTML, CSV, PDF, etc.

!!!note "XSLT (Extensible Stylesheet Language Transformations)"
     És un **llenguatge de transformació** per a documents XML. Permet escriure **regles** per **transformar dades XML** en qualsevol format desitjat.

XSLT Utilitza un conjunt de fulls d'estils (stylesheets) escrits en XSLT per transformar documents XML a altres formats. Es poden definir plantilles per adaptar les dades al format de destinació.

A més, tenim un parell de tecnologies més: XPath i XSL-FO.

* **XPath (XML Path Language)**: És un llenguatge que **permet navegar i seleccionar parts d’un document XML**. Es fa servir dins d’XSLT per a seleccionar nodes específics dins d'un document XML.
* **XSL-FO (Extensible Stylesheet Language Formatting Objects)**: Aquesta tecnologia s'utilitza per generar documents formats, com PDF, a partir de XML. Permet definir el disseny i format de documents de manera estructurada.

## Sintaxi i llenguatges específics per a la conversió

En aquest apartat, veurem la sintaxi bàsica de **XSLT**, que és l'eina més comuna per convertir documents **XML** a altres formats. També abordarem **XPath**, que és el llenguatge utilitzat per seleccionar nodes dins d'un document **XML**.

#### Sintaxi bàsica de XSLT

**XSLT** (Extensible Stylesheet Language Transformations) és un llenguatge de transformació per a documents **XML**. Es fa servir per convertir un document **XML** en altres formats, com **HTML**, **CSV**, **XML** o fins i tot **PDF** (a través d'XSL-FO).

Un **full d'estils XSLT conté plantilles que defineixen com transformar els elements XML en l'eixida** desitjada. Aquestes plantilles s'especifiquen mitjançant la sintaxi de XSLT.

#### Components principals de XSLT

1. **Element `xsl:stylesheet`**:
   El document XSLT comença amb l'element **`xsl:stylesheet`**, que defineix que el document utilitza **XSLT** i inclou l'espai de noms necessari.

   Exemple:
   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
   ```
   
2. **Element `xsl:template`**:
   L'element **`xsl:template`** defineix una plantilla que es farà servir per transformar els **elements XML** en el resultat desitjat. Per seleccionar l'etiqueta fem ús de la propietat `match`.

   Exemple:
   ```xml
   <xsl:template match="pizzes">
       <!-- Contingut per transformar -->
   </xsl:template>
   ```

3. **Element `xsl:value-of`**:
   L'element **`xsl:value-of`** s'utilitza per extreure el valor d'un node XML i inserir-lo en la sortida. Fem ús de `select` per indicar el valor de l'atrobur que volem.

   Exemple:
   ```xml
   <xsl:value-of select="nom"/>
   ```

4. **Element `xsl:for-each`**:
   **`xsl:for-each`** permet iterar sobre un conjunt de nodes i generar una llista d'elements (com llistes ordenades o desordenades, taules, etc. en HTML) a partir de múltiples elements **XML**.

   Exemple:

   ```xml
   <xsl:for-each select="pizza">
       <tr>
           <td><xsl:value-of select="nom"/></td>
           <td><xsl:value-of select="preu"/></td>
       </tr>
   </xsl:for-each>
   ```

5. **Element `xsl:output`**:
   L'element **`xsl:output`** defineix el tipus d'eixida que es generarà (per exemple, **HTML**).

   Exemple:
   ```xml
   <xsl:output method="html"/>
   ```

!!!note "Creació d’especificacions de conversió"
     Per tal de realitzar la conversió d'un document hem de definir clarament com serà el document d'eixida, incloent les regles de transformació i els formats de destinació. Per això caldrà definir:

     * **Les regles de mapeig**: Quins elements del document XML es mapegen a quins elements en el format d'eixida.
     * **Els requisits de format**: Com ha de ser l'aspecte final (per exemple, una taula HTML, un PDF amb un disseny específic, etc.).
     * **Els tipus de dades**: Quins tipus de dades s’han de transformar (p. ex., dates, nombres, textos).


!!!example "Exemple complet"

     Imaginem que tenim el document **XML** següent amb informació de pizzes:

     ```xml
     <pizzes>
         <pizza>
             <nom>Pizza Margarita</nom>
             <preu>9.99</preu>
         </pizza>
         <pizza>
             <nom>Pizza Quattro Formaggi</nom>
             <preu>12.99</preu>
         </pizza>
     </pizzes>
     ```
     
     Podem utilitzar el següent full d'estils **XSLT** per convertir aquest **XML** en **HTML**. Observeu com incloem l'estructura d'HTML directament a l'XSLT:

     ```xml
      <?xml version="1.0" encoding="UTF-8"?>
        <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
            <xsl:output method="html"/>

            <!-- Plantilla per transformar l'element "pizzes" -->
            <xsl:template match="/pizzes">
                <html>
                    <head>
                        <title>Menu de Pizzes</title>
                    </head>
                    <body>
                        <h2>Les nostres Pizzes</h2>
                        <table border="1">
                            <tr>
                                <th>Nom</th>
                                <th>Preu</th>
                            </tr>
                            <!-- Iteració sobre cada element "pizza" -->
                            <xsl:for-each select="pizza">
                                <tr>
                                    <td><xsl:value-of select="nom"/></td>
                                    <td><xsl:value-of select="preu"/></td>
                                </tr>
                            </xsl:for-each>
                        </table>
                    </body>
                </html>
            </xsl:template>
      </xsl:stylesheet>
     ```

     Per tal de realitzar la conversió de forma ràpida, des de la terminal podem fer ús del paquet xsltproc. Aquest no ve per defecte, pel que s'ha d'instal·lar amb:

     ```bash
     $ sudo apt install xsltproc
     ```

     Una vegada instal·lat, si tenim el fitxer XML en pizzes.xml i el fitxer XSLT en pizza.xsl, podem fer la conversió des de la terminal amb:

     ```bash
     $ xsltproc pizza.xsl pizzes.xml > eixida.html
     ```

     Amb el que obtindrem el codi HTML corresponent.


### Expressions XPath per a la selecció de nodes i funcions principals

**XPath** és un llenguatge que permet **navegar** i **seleccionar nodes** dins d'un document **XML**. Es fa servir tant dins de **XSLT** com en altres tecnologies basades en **XML**, com **XQuery** o fins i tot en la validació de documents XML.

Les expressions **XPath** són molt poderoses, ja que permeten seleccionar nodes, aplicar filtres, i fins i tot realitzar càlculs sobre els valors dels nodes.

#### Sintaxi bàsica d'XPath

- **Seleccionar l'element arrel**: `/` selecciona l'arrel del document.
  
  Exemple:
  ```xpath
  /pizzes
  ```

- **Seleccionar un element concret**: `//` selecciona tots els nodes coincidents independentment de la seva ubicació al document.
  
  Exemple:
  ```xpath
  //pizza
  ```

- **Seleccionar un element per nom**: Per seleccionar un element dins d'un altre, es fa servir `element/nom_del_node`.
  
  Exemple:
  ```xpath
  /pizzes/pizza
  ```

- **Condicions amb `[]`**: Podem afegir condicions dins de les claus `[]` per seleccionar nodes que compleixin certs criteris.

  Exemple:
  ```xpath
  //pizza[vegetariana='true']
  ```

- **Funcions principals de XPath**:
  - **`text()`**: Retorna el valor del text d'un node.
  - **`contains()`**: Comprova si una cadena conté un valor.
  
  Exemple:
  ```xpath
  //pizza[contains(nom, 'Margarita')]
  ```

Cal tindre en compte que totes aquestes funcions es poden combinar. Per exemple, la següent consulta:

```xpath
//pizza[preu/text()>10 and contains(nom/text(), 'Formaggi')]
```

Retornaria totes les pizzes, on el preu siga més de 10€ i que a més continguen el text "Formaggi" en el nom.

#### Exemple d'ús d'XPath dins de **XSLT**

Dins d'un **XSLT**, es poden utilitzar expressions **XPath** dins els selectors, tipus `match` o `select`, per seleccionar els nodes i aplicar transformacions. Per exemple, per obtenir totes les **pizzes vegetarians** i crea una llista a **HTML** amb els seus noms i preus:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
    <xsl:output method="html" />
    <xsl:template match="/pizzes">
        <html>
            <body>
                <h2>Pizzes Vegetarianes</h2>
                <ul>
                    <!-- Seleccionar només les pizzes vegetarianes -->
                    <xsl:for-each select="pizza[vegetariana='true']">
                        <li><xsl:value-of select="nom" /> - <xsl:value-of select="preu" /></li>
                    </xsl:for-each>
                </ul>
            </body>
        </html>
    </xsl:template>
</xsl:stylesheet>
```

!!!note "Fitxer d'exemple"
     Disposeu dels fitxers [`pizza.xsl`](xsl/pizza.xsl),  [`vegetarianes.xsl`](xsl/vegetarianes.xsl) i [`pizzes.xml`](xsl/pizzes.xml) per descarregar i provar les diferents ordres.


!!!question "Activitats"

    Crea els corresponents esquemes de transformació (XSLT i XPath) per treballar sobre el fitxer pizzes.xml per a:

    1. Mostrar totes les pizzes vegetarianes en una taula
    2. Mostrar només les pizzes amb al·lèrgens "gluten" i "lactosa"
    3. Obté una llista amb totes les pizzes amb un preu superior a 10€.
    4. Mostra una llista de pizzes vegetarianes, junt amb els seus al·lergens.
    5. Mostra una taula (nom i preu) amb les pizzes que continguen el text "Quatre" en el nom.


!!!note "Altres eines específiques"

     Ja hem vist com amb la línia d'ordres i l'eina `xsltproc`podem realitzar aquesta transformació de documents.

     Aquesta és una opció fàcil i molt utiltizada per a la conversió des de la línia d'ordres, però hi ha d'altres eines més potents i completes:

     * **Saxon**: Un motor de transformació XSLT que és àmpliament utilitzat per la seva robustesa i compatibilitat amb diferents versions d'XSLT.
     * **Xalan**: Un altre processador XSLT que permet realitzar transformacions XSLT de manera eficient. Ofereix suport tant per a XSLT 1.0 com per a versions posteriors.
     * **FOP (Formatting Objects Processor)**: Aquest processador converteix documents XML amb XSL-FO en PDF.

## Transformació amb XSLT i JavaScript

Des de javascript podem aplicar transformacions de fitxers XML mitjançant XSLT, fent ús de les eines [DOMParser](https://developer.mozilla.org/es/docs/Web/API/DOMParser) i [XSLTProcessor](https://developer.mozilla.org/en-US/docs/Web/API/XSLTProcessor). 

**DOMParser** és un analitzador de codi XML/HTML, amb el qual podem llegir una cadena de text i convertir-la en un document DOM per al seu tractament. Per la seua banda, **XSLTrocessor** ens permet aplicar les transformacions XSLT a un document XML, retornant un document XSML com a eixida.

Veiem-ho amb un exemple. Tenim el següent esquelet amb HTML:


```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transformació XML a HTML</title>
</head>
<body>
    <h1>Resultat de la transformació XML a HTML</h1>
    
    <div id="result"></div>

    <script src="generaHTML.js"></script>
</body>
</html>
```

Com veiem, hem definit un contenidor de tipus `div` anomenat `result`, al qual afegirem el resultat de la transformació. Anem a veure què conté l'script `generaHTML.js`.

En primer lloc, dins l'script, i una vegada carregat el DOM, creem directament un parell de cadenes de text, una per a l'XML original i altra per al XSLT. Per això tenim la següent funció:

```js
function carregaDocuments() {
    // Carreguem el document XML i el document XSLT
    const xmlString = `<?xml version="1.0" encoding="UTF-8"?>
            <pizzes>
                <pizza>
                    <nom>Pizza Margarita</nom>
                    <preu>9.99</preu>
                </pizza>
                <pizza>
                    <nom>Pizza Quattro Formaggi</nom>
                    <preu>12.99</preu>
                </pizza>
            </pizzes>`;

    const xsltString = `<?xml version="1.0" encoding="UTF-8"?>
            <xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
                <xsl:output method="html"/>
                <xsl:template match="/pizzes">
                    <html>
                        <body>
                            <h2>Menu de Pizzes</h2>
                            <table border="1">
                                <tr>
                                    <th>Nom</th>
                                    <th>Preu</th>
                                </tr>
                                <xsl:for-each select="pizza">
                                    <tr>
                                        <td><xsl:value-of select="nom"/></td>
                                        <td><xsl:value-of select="preu"/></td>
                                    </tr>
                                </xsl:for-each>
                            </table>
                        </body>
                    </html>
                </xsl:template>
            </xsl:stylesheet>`;

    //Retornem les dues cadenes com un objecte estructurat
    return { xmlString, xsltString };

}
```

I el codi principal: 

```js

addEventListener("DOMContentLoaded", () => {

    // Carreguem les dues cadenes, amb desestructuració
    let { xmlString, xsltString } = carregaDocuments();

    ///...
    
})
```

Una vegada tenim aquestes cadenes (recorda que per ara són només cadenes de text), les hem de convertir a objectes DOM, per poder-les tractar, per a això, fem ús del mètode `parseFromString` del `DOMParser`, de la següent manera:

```js
// Creem els objectes XML i XSL a partir de les cadenes
const parser = new DOMParser();
const xmlDoc = parser.parseFromString(xmlString, "application/xml");
const xslDoc = parser.parseFromString(xsltString, "application/xml");
```

Amb això ja tenim els DOM de l'XML i l'XSLT, ara necessitarem un processador XSLT, al qual *carregar* el nostre XSLT:

```js
// Creem un processador XSLT
const xsltProcessor = new XSLTProcessor();
xsltProcessor.importStylesheet(xslDoc);
```

I una vegada creat, apliquem la transformació a l'XML, i l'afegim al div `result`:

```js

// Apliquem la transformació i obtenim el resultat
const resultDocument = xsltProcessor.transformToFragment(xmlDoc, document);
// Inserim el resultat en el DOM
document.getElementById("result").appendChild(resultDocument);
```

!!!question "Activitats"
     Prova a obtenir ara els fitxers des d'Internet, amb fetch, i realitza la mateixa operació.

     Els fitxers necessaris els tindràs a:

     * XML amb les pizzes: ([ttps://pizza-rest-server-production.up.railway.app/xml/pizzes_sense_paginacio.xml](https://pizza-rest-server-production.up.railway.app/xml/pizzes_sense_paginacio.xml)
     * XSLT amb els fulls d'estil de transformació: [https://pizza-rest-server-production.up.railway.app/xml/xslt/taula_pizzes.xsl](https://pizza-rest-server-production.up.railway.app/xml/xslt/taula_pizzes.xsl)
