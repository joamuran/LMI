# Validació de documents per a l'intercanvi d'informació

Anem a veure la importància de descriure correctament la informació, i com podem validar aquesta amb tecnologies com DTD i XSD.

## Validació de documents

Quan parlem de **validació** d’un document per a l’intercanvi d’informació, habitualment ens referim a un procés que verifica:

1. **Estructura**: Que el document segueix la jerarquia lògica i el conjunt d’etiquetes definit.
2. **Contingut**: Que els tipus de dades i restriccions (noms d’etiqueta, valors, ordre) responen a unes regles definides.

En l’àmbit dels llenguatges de marques això ens aporta:

* **fiabilitat**, ja que el receptor del document el podrà interpretar sense ambigüitats,
* **interoperabilitat** entre sistemes que *entenen* el mateix idioma, i
* **qualitat de la informació**, ja que evita errors de sintaxi en noms d’etiquetes i atributs, i facilita la detecció d’incoherències.

!!! info "Conceptes"

    * **Document bé format**: Un document ben format és aquell que compleix amb els requisits bàsics de sintaxi (etiquetes correctament anidades, element arrel únic, etc.).  
    * **Document vàlid**: Un document és vàlid quan és ben format, i a més compleix les regles marcades a la seua definició (DTD o XSD).


## Tecnologies de definició de documents: DTD i XSD

Per descriure les regles d’un document XML, s’utilitzen principalment dos mètodes:

1. **Definició de tipus de document (DTD)**  
    - Un mecanisme més antic i senzill, però amb limitacions pel que fa a tipus de dades avançats o espais de noms.  
    - Sintaxi pròpia (no és XML) i en general és menys extensible.  
    - Definim quins elements poden aparéixer, en quin ordre, quins atributs i amb quin tipus (CDATA, ID, etc.).

2. **XML Schema (XSD)**  
    - Evolució més potent que la DTD, redactada **en format XML**.  
    - Permet definir **tipus de dades rics** (booleans, enters, dates, etc.), **restriccions** precises (longitud, rang, patrons...).  
    - Suporta **espais de noms** (namespaces) i la integració amb altres esquemes, fent-lo molt adequat per a entorns complexos.  

Actualment, l’ús de **XSD** és molt freqüent en aplicacions web, serveis (SOAP, REST), i plataformes que requereixen intercanvi de dades amb tipatge exacte.

## Descripció de documents: DTS i XSD

### DTD

Un DTD es pot definir de manera local (interna al document) o de manera externa (amb un fitxer extern):

* De manera interna:
   ```xml
   <!DOCTYPE nom_arrel [
   <!ELEMENT nom_arrel (fill1, fill2?)>
   <!ELEMENT fill1 (#PCDATA)>
   <!-- etc. -->
   ]>
   ```
* De manera externa: 
  ```xml
  `<!DOCTYPE nom_arrel SYSTEM "fitxer.dtd">`
  ```

Un DTD bàsicament definex:

* **Elements**: Es descriuen amb `<!ELEMENT NomElement (regles_contenidor)>`.  
* **Atributs**: `<!ATTLIST NomElement NomAtribut Tipus #REQUIRED o #IMPLIED ...>`.  
* **Entitats** i **notacions**: Mètodes per a constants, incloure referències externes (imatges, etc.).

!!! example Exemple
    Si accediu a [aquest enllaç](https://pizza-rest-server-production.up.railway.app/xml/pizzes.xml) veureu un exemple de la informació que teniem sobre la pizzeria en format XML.

    Un possible DTD per validar aquest document seria:

    ```xml
    <!ELEMENT pizzes (page, per_page, total_count, records, pizza+)>
    <!ELEMENT page (#PCDATA)>
    <!ELEMENT per_page (#PCDATA)>
    <!ELEMENT total_count (#PCDATA)>
    <!ELEMENT records (pizza+)>
    <!ELEMENT pizza (nom, descripcio, ingredients, vegetaria, gluten, lactosa, imatge, preu)>
    <!ELEMENT nom (#PCDATA)>
    <!ELEMENT descripcio (#PCDATA)>
    <!ELEMENT ingredients (#PCDATA)>
    <!ELEMENT vegetaria (#PCDATA)>
    <!ELEMENT gluten (#PCDATA)>
    <!ELEMENT lactosa (#PCDATA)>
    <!ELEMENT imatge (#PCDATA)>
    <!ELEMENT preu (#PCDATA)>
    ```

    On tenim:

    * `<pizzes>` és l'element arrel, que conté informació relacionada amb les pizzes i la paginació. Aquest inclou:
      * `<page>`: El número de la pàgina actual.
      * `per_page>` El nombre de pizzes per pàgina.
      * `<total_count>`: El total de pizzes disponibles a la base de dades.
      * `<records>`: Un element que conté múltiples elements `<pizza>`, representant cada una de les pizzes a la pàgina actual.
      * `<records>`: Aquest element conté una llista de pizzes (<pizza>), que són els registres actuals en la pàgina de resultats. **Observeu el `+` que acompanya la pizza i que defineix una llista**.
      * `<pizza>`: Representa una pizza individual amb els següents subelements:
        * `<nom>`: Nom de la pizza (ex. "Pizza Margarita").
        * `<descripcio>`: Descripció de la pizza.
        * `<ingredients>`: Llista d'ingredients.
        * `<vegetaria>`: Indica si la pizza és vegetaria (true/false).
        * `<gluten>`: Indica si la pizza conté gluten (true/false).
        * `<lactosa>`: Indica si la pizza conté lactosa (true/false).
        * `<imatge>`: URL de la imatge de la pizza.
        * `<preu>`: Preu de la pizza.

!!!info "Més informació.."

    * [DTD: Definición de Tipo de Documento, en McLibre](https://www.mclibre.org/consultar/xml/lecciones/xml-dtd.html), amb un [ressum](https://www.mclibre.org/consultar/xml/lecciones/xml-dtd-resumen.html)
    * [DTDs](https://lm-xml-apuntes.readthedocs.io/apuntes/30_dtds.html)

### XSD (XML Schema)

**XML Schema** ens permet definir l'estructura i les restriccions del contingut dels documents XML de manea més precisa que el DTD.

A continució se't mostra com seria l'**XSD** per tal de descriure l'estructura del fitxer XML per a la informació paginada de la pizzeria. Intenta detectar en ell:

* Es defineix algun espai de noms?
* Quina etiqueta s'usa per definir elements simples?
* Quina etiqueta s'usa per definir elements compleos com llistes?
* S'indica d'alguna manera el tipat de les dades?

```xml
<?xml version="1.0" encoding="utf-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">

    <!-- Definició de l'element "pizzes" -->
    <xs:element name="pizzes">
        <xs:complexType>
            <xs:sequence>
                <!-- Elements de la paginació -->
                <xs:element name="page" type="xs:int"/>
                <xs:element name="per_page" type="xs:int"/>
                <xs:element name="total_count" type="xs:int"/>
                <!-- L'element "records" conté les pizzes -->
                <xs:element name="records">
                    <xs:complexType>
                        <xs:sequence>
                            <!-- Un o més elements de "pizza" -->
                            <xs:element name="pizza" maxOccurs="unbounded">
                                <xs:complexType>
                                    <xs:sequence>
                                        <!-- Informació de la pizza -->
                                        <xs:element name="nom" type="xs:string"/>
                                        <xs:element name="descripcio" type="xs:string"/>
                                        <xs:element name="ingredients" type="xs:string"/>
                                        <xs:element name="vegetaria" type="xs:boolean"/>
                                        <xs:element name="gluten" type="xs:boolean"/>
                                        <xs:element name="lactosa" type="xs:boolean"/>
                                        <xs:element name="imatge" type="xs:string"/>
                                        <xs:element name="preu" type="xs:decimal"/>
                                    </xs:sequence>
                                </xs:complexType>
                            </xs:element>
                        </xs:sequence>
                    </xs:complexType>
                </xs:element>
            </xs:sequence>
        </xs:complexType>
    </xs:element>

</xs:schema>
```

Examinem aquest esquema:

1. **`<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">`**:
   - Aquest és el **namespace** per a XSD, que ens permet utilitzar els elements de l'esquema XML definits per W3C.

2. **`<xs:element name="pizzes">`**:
   - Defineix l'element arrel del document XML, **pizzes**. Això serà l'element que contindrà tota la informació sobre les pizzes i la paginació.

3. **`<xs:complexType>` i `<xs:sequence>`**:
   - Indiquen que l'element **pizzes** conté altres elements (en aquest cas, els de paginació i els registres de pizzes) i que aquests elements apareixen en un ordre determinat.

4. **Elements de paginació**:
   - **`<xs:element name="page" type="xs:int"/>`**: El número de pàgina, que ha de ser un **enter** (`xs:int`).
   - **`<xs:element name="per_page" type="xs:int"/>`**: Nombre de pizzes per pàgina, també un **enter**.
   - **`<xs:element name="total_count" type="xs:int"/>`**: El nombre total de pizzes disponibles.

5. **L'element `records`**:
   - **`<xs:element name="records">`**: Un element que conté tots els registres de les pizzes. És un **complextype** amb un **`maxOccurs="unbounded"`**, la qual cosa significa que pot contenir moltes pizzes (literalment unbounded sería *sense límits*).

6. **Definició de l'element `pizza`**:
   - Cada **`<pizza>`** té diversos subelements, que es defineixen amb el tipus de dada corresponent:
     - **`<nom>`** i **`<descripcio>`**: Strings (`xs:string`), contenen el nom i la descripció de la pizza.
     - **`<vegetaria>`**, **`<gluten>`** i **`<lactosa>`**: **Booleans** (`xs:boolean`), indiquen si la pizza és vegetaria, conté gluten o lactosa.
     - **`<imatge>`**: Una cadena (`xs:string`), que conté la URL de la imatge.
     - **`<preu>`**: Un valor decimal (`xs:decimal`), que indica el preu de la pizza.

### Com utilitzar l'XSD per validar el document XML

Per utilitzar aquest XSD per validar un document XML, el document XML ha de tenir una referència a l'esquema XSD, de la següent manera:

```xml
<?xml version="1.0" encoding="utf-8"?>
<pizzes xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="https://pizza-rest-server-production.up.railway.app/xml/xsd pizzes.xsd">
    <page>1</page>
    <per_page>10</per_page>
    <total_count>100</total_count>
    <records>
        <pizza>
            <nom>Pizza Margarita</nom>
            <descripcio>Base fina, tomaca, mozzarella i alfàbrega.</descripcio>
            <ingredients>Tomaca, mozzarella, alfàbrega</ingredients>
            <vegetaria>true</vegetaria>
            <gluten>false</gluten>
            <lactosa>true</lactosa>
            <imatge>http://example.com/margarita.jpg</imatge>
            <preu>8.5</preu>
        </pizza>
        <pizza>
            <nom>Pizza Quatre Estacions</nom>
            <descripcio>Amb xampinyons, pernil, olives i formatge.</descripcio>
            <ingredients>Xampinyons, pernil, olives, formatge</ingredients>
            <vegetaria>false</vegetaria>
            <gluten>true</gluten>
            <lactosa>true</lactosa>
            <imatge>http://example.com/quatre_estacions.jpg</imatge>
            <preu>10.0</preu>
        </pizza>
    </records>
</pizzes>
```

Aci es fa referència a l'esquema **pizzes.xsd** mitjançant l'atribut **`xsi:schemaLocation`**, qui indica al processador XML on trobar l'XSD que validarà el document XML.

!!!note "Creació de descripcions de documents"
     A l'hora de genera un DTD o XSD, comencem per identificar:
    
     1. **L’arrel** o element principal (p. ex. `<agenda>`, `<biblioteca>`...).  
     2. **Els subelements** i l’ordre, si és obligatori o opcional (DTD: `(#PCDATA)`, `*`, `+`, `?`, etc.; XSD: `<xs:sequence>`, `<xs:choice>`, etc.).  
     3. **Els atributs**: de quin tipus són (CDATA, ID, enumeracions, etc.).  
     4. **Restriccions de valor**: en XSD, l’ús de `<xs:restriction>` amb facetes.

     A partir de tot això, redactarem la definició. En XSD, sovint és útil crear **tipus simples** per a conceptes comuns (telèfon, codi postal), i **tipus complexos** per a estructures repetides (adreça, persona...). Les bones pràctiques inclouen:
     - Reutilitzar tipus definits.  
     - Separar en esquemes externs, si es preveu compartir-los.  
     - Documentar amb `<xs:annotation>` i `<xs:documentation>`.

!!!info "Més informació..."
     
     * [XSD](https://lm-xml-apuntes.readthedocs.io/apuntes/40_esquemas_xml.html)

### Validació i associació

Ja hem vist com associr el DTD o XSD al document.

* **Amb DTD**: Enllaçant el DTD com a fitxer extern o en la pròpia definició de l'XML.
    ```xml
    <!DOCTYPE arrel SYSTEM "arxiu.dtd">
    ```
* **Amb XSD**: Fem ús dels atributs `xmlns:xsi` i `xsi:schemaLocation`, per exemple:  
    ```xml
    <arrel xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://www.exemple.org  arrel.xsd">
        ...
    </arrel>
    ```

Per tal de validar els documents, necessitem un **programa analitzador** (parser) o una **eina de validació**, el qual:

* Verifica que el document estiga **bé format**. 
* Comprova que cada element i atribut compleix el **DTD/XSD**.

Si hi ha algun error (etiquetes mal anidades, valors fora de rang, etc.), la validació **falla** i rebem missatges que ajuden a corregir el document. Un cop validat, tenim la **garantia** que la informació és coherent amb el model definit.

#### Eines específiques per a la validació i el disseny d’esquemes

Existixen diverses **eines i plataformes** que faciliten tant la creació de definicions (DTD/XSD) com la validació i la depuració de possibles errors:

1. **Editors i validadors en línia**  
   - [Freeformatter XML Validator](https://www.freeformatter.com/xml-validator-xsd.html)  
   - [Utilities-Online XSD Validation](https://www.utilities-online.info/xsdvalidation)  
   - Etc.

!!!question "Activitat. Validació i correcció d'errors."
    * Fes ús d'un d'aquests validadors en línia i comprova si el fitxer de les pizzes en XML es valida correctament contra l'XSD.
    * Com hauràs comprovat, apareixen diversos errors de validació, per tant, l'XML no és correcte. Intenta entendre què et diuen aquests errors i modifica l'XSD per a que la validació siga correcta.

<!-- Fitxer XSD corregit:-> https://pizza-rest-server-production.up.railway.app/xml/xsd/pizzes2.xsd
Fitxer XML que usa aquest XSD: https://pizza-rest-server-production.up.railway.app/xml/pizzes_xsd.xml
-->