# Javascript, formularis i DOM

Una de les principals aplicacions de Javascript és la validació de formularis i la seva manipulació, especialment en combinació amb tècniques AJAX per a comunicacions asíncrones. Quan el navegador carrega una pàgina web i construeix el DOM, es creen referències a tots els formularis i als seus elements.

Per tal d'accedir a un formulari, tradicionalment s'ha fet mitjançant el component `forms` del DOM. Veiem alguns exemples:

```js
// Vector de formularis del document
document.forms; 

// Primer formulari del document
document.forms[0]; 

// Vector d'elements del formulari
document.forms[0].elements; 

// Primer element del primer formulari
document.forms[0].elements[0]; 

// Últim element del primer formulari
document.forms[0].elements[document.forms[0].elements.length - 1]; 
```

Tot i que aquesta manera de fer referència als formularis és funcional, actualment es recomana utilitzar **selectors CSS** o referències basades en els atributs `id` o `name` per millorar la llegibilitat i mantenibilitat.

Veiem un exemple:

```html
<form name="nouAlumne">
	<input type="text" name="nom_alumne" id="nom_alum" />
</form>
```

```js
// Accés al formulari amb querySelector
const form = document.querySelector('form[name="nouAlumne"]');

// Accés a l'input pel seu id
const input = document.getElementById('nom_alum');

// Accés a l'input pel seu atribut name
const inputByName = form.querySelector('[name="nom_alumne"]');
```

Cadascun dels elements d'un formulari disposa de propietats clau, com:

| Propietat      | Descripció                                                                                          |
|-----------------|----------------------------------------------------------------------------------------------------|
| `type`          | Tipus de l'element (`input`, `select`, `textarea`, etc.).                                          |
| `form`          | Referència al formulari que conté l'element.                                                       |
| `name`          | Valor de l'atribut `name` de l'element.                                                            |
| `value`         | Valor actual de l'element.                                                                        |
| `checked`       | Indica si un checkbox o radiobutton està seleccionat (booleà).                                     |

A més, hi ha esdeveniments específics relacionats amb formularis, com:

| Esdeveniment    | Descripció                                                                                        |
|-----------------|--------------------------------------------------------------------------------------------------|
| `onclick`       | Quan l'usuari fa clic a un element, com un botó.                                                  |
| `onchange`      | Quan es canvia el valor d'un element, com un `<input>` o `<select>` (després de perdre el focus). |
| `onfocus`       | Quan un element guanya el focus.                                                                 |
| `onblur`        | Quan un element perd el focus.                                                                   |


## Treballant amb formularis

### Accés al valor dels camps d'un formulari

Anem a veure com accedir al valor dels diferents elements segons el seu tipus:

* **Quadres de text i Textarea**: Accedim mitjançant la propietat `value`

```html
<input type="text" id="text1" />
<textarea id="textarea1"></textarea>
```

```js
// Accedir al valor
const valorText = document.getElementById('text1').value;
const valorTextarea = document.getElementById('textarea1').value;
```

* **Radiobuttons**: Per saber si un `radioButton` està seleccionat fem ús de la propietat `checked`. Independentment de si està o no seleccionat, podem accedir a la seua propietat `value`, definida a l'HTML. Recordeu també que quan diversos inputs de tipus *radio* tenen el mateix `name`, només un d'ells podrà estar seleccionat.

```html
<input type="radio" value="tren" name="vehicle" id="r1">Tren
<input type="radio" value="cotxe" name="vehicle" id="r2">Cotxe
```

```js
const radiobuttons = document.getElementsByName('vehicle');
for (let rb of radiobuttons) {
    if (rb.checked) {
        console.log(`Vehile seleccionat: ${rb.value}`);
    }
}
```

* **Checkbox**: També disposa de la propietat *checked* per saber si està marcat o no.
  
```html
<input type="checkbox" id="cb1" />
```

```js
const isChecked = document.getElementById('cb1').checked;
```

* **Select**: Un `select` pot contindre diversos elements de tipus `option`. Amb `selectedIndex` podem accedir a l'índex de l'element seleccionat, mentre que amb `options`, podem accedir a la llista d'elements de tipus `option`que hi conté. D'aquesta manera, podem saber l'opció seleccionada amb `select.options[select.selectedIndex];`. Una vegada sabem quina és l'opció seleccionada, podem accedir a les seues propietat `value` o `text`:

```html
<select id="opcions">
	<option value="1">Valor 1</option>
	<option value="2">Valor 2</option>
</select>
```
```js
const select = document.getElementById('opcions');
const selectedOption = select.options[select.selectedIndex];
console.log(`Valor: ${selectedOption.value}, Text: ${selectedOption.text}`);
```
### Validació de formularis

Com sabem, Javascript va ser ideat inicialment per a la validació de formulari. Veiem com fer-ho:

#### Validació amb Javascript

La validació des de Javascript consisteix a associar una funció gestora a l’esdeveniment `submit` (enviar) del formulari. Aquesta funció pot utilitzar expressions regulars per validar entrades i impedir l'enviament si cal.

Veiem un exemple complet:

```html
<form id="altaAlumne">
    <label for="nomAlumne">Nom (*):</label>
    <input type="text" id="nomAlumne" required />

    <label for="email">Correu electrònic (*):</label>
    <input type="email" id="email" required />

    <input type="submit" value="Enviar" />
</form>

<div id="errors"></div>
```
```js
document.getElementById('altaAlumne').addEventListener('submit', function (event) {
    // Evitem que s'envie per defecte
    event.preventDefault();

    // Vector per als errors
    const errors = [];

    // Agafem el valor de nomAlumne i email, eliminant els espais als costats (trim)
    const nom = document.getElementById('nomAlumne').value.trim();
    const email = document.getElementById('email').value.trim();

    // Validació del nom amb una expressió regular
    if (!/^[A-Za-z\s]+$/.test(nom)) {
        // Si el nom no segueix l'expressió regular
        // Afegim un missatge al final de la llista d'errors (push)
        errors.push('El nom només pot contenir lletres.');
    }

    // Validació del correu electrònic amb una expressió regular
    if (!/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,4})+$/.test(email)) {
        // Si el correu no segueix l'expressió regular
        // Afig també un error al final
        errors.push('El correu electrònic no és vàlid.');
    }

    // Mostrar errors
    const errorsDiv = document.getElementById('errors');
    // Amb join() combinem tots els elements d'un vector,
    // separats per la cadena indicada
    errorsDiv.innerHTML = errors.join('<br>');

    // Si no hi ha errors, enviar el formulari
    if (errors.length === 0) {
        alert('Formulari enviat correctament!');
    }
});
```


L'etiqueta `<input>`, sobretot a partir d'HTML5, defineix nous tipus d'entrada de dades i atributs, que incorporen certes restriccions als seus valors. Entre ells, i a mode de repàs  d'HTML5, podem destacar:

* **Restriccions per als `inputs` clàssiques**

| Tipus | Descripció |
|----|-----------------------------------|
| disabled  | Indica que un camp d'entrada està desactivat |
| maxlength | Indica el número màxim de caràcters per a l'entrada |
| readonly | Indica que el valor de l'input no pot variar |
| size | Indica la grandària de l'input en caràcters |
| value | Indica un valor per defecte per a l'input |


* **Restriccions per als `inputs` amb HTML5**

| Tipus | Descripció |
|----|-----------------------------------|
| max | Indica el valor màxim per al camp |
| minSpecifies | Indica el valor mínim per al camp |
| pattern | Indica una expressió regular per al camp |
| required  Indica que el camp ha de tindre necessàriament un valor |
| step | Indica els valor dels bots entre els valors que fa una entrada de tipus numèric |

A més, disposem de tipus d'`input` especials, com poden ser:

| Input type        | Descripció                                                                 | Restriccions i validacions                                                                      |
|-------------------|---------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------|
| `email`           | Indica que el camp és un correu electrònic.                              | Comprova que el valor tinga un format de correu electrònic vàlid (e.g., `example@mail.com`). |
| `url`             | Indica que el camp és una URL.                                           | Comprova que el valor tinga un format vàlid d'URL (ex., `https://example.com`).            |
| `month`           | Permet seleccionar un mes específic (any i mes).                        | Pot incloure `min`, `max` i `step` per restringir els valors permesos.                       |
| `time`            | Permet seleccionar una hora.                                             | Pot incloure `min`, `max` i `step` per intervals (ex., `step="900"` per passos de 15 min).  |
| `number`          | El camp és un valor numèric.                                             | Accepta atributs `min`, `max` i `step` per definir rangs i increments.                      |
| `date`            | Permet seleccionar una data mitjançant un calendari.                    | Atributs `min` i `max` per restringir l'interval de dates disponibles.                      |
| `datetime-local`  | Permet seleccionar una data i una hora (sense zona horària).             | Combinació de restriccions de `date` i `time` (`min`, `max`, `step`).                        |
| `range`           | Selector lliscant per a valors numèrics dins d'un rang.                 | Necessita `min` i `max`; `step` per definir increments.                                      |
| `color`           | Permet seleccionar un color mitjançant un selector gràfic.              | No té validacions específiques; retorna un valor hexadecimal (e.g., `#ffffff`).             |
| `tel`             | Per a camps de números de telèfon.                                      | Sense validació nativa del format; pot utilitzar-se amb `pattern` per validar-lo.           |
| `search`          | Camp optimitzat per cerques amb opcions natives per esborrar text.       | No té validacions específiques.                                                             |
| `week`            | Permet seleccionar una setmana específica d'un any.                    | Atributs `min` i `max` per definir rangs de setmanes disponibles.                           |
| `file`            | Permet carregar fitxers des del dispositiu de l'usuari.                 | Atributs `accept` per limitar els tipus de fitxer i `multiple` per permetre'n diversos.     |


Veiem un exemple complet amb diverses validacions:

```html
<!DOCTYPE html>
<html lang="ca">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulari d'Inscripció</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }

        form {
            max-width: 600px;
            margin: 0 auto;
        }

        label {
            font-weight: bold;
        }

        input,
        select,
        button {
            display: block;
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            box-sizing: border-box;
        }

        input[type="range"] {
            width: calc(100% - 20px);
            margin: 10px auto;
        }

        button {
            width: auto;
        }
    </style>
</head>

<body>

    <h1>Formulari d'Inscripció a l'Esdeveniment</h1>
    <p>Ompliu aquest formulari per registrar-vos al nostre esdeveniment.</p>

    <form id="formulari" action="" method="POST" enctype="multipart/form-data">
        <!-- Dades personals -->
        <fieldset>
            <legend>Dades Personals</legend>

            <label for="nom">Nom complet *</label>
            <input type="text" id="nom" name="nom" required pattern="[A-Za-z\s]+" placeholder="Exemple: Maria Pérez">

            <label for="email">Correu electrònic *</label>
            <input type="email" id="email" name="email" required placeholder="exemple@mail.com">

            <label for="telefon">Telèfon</label>
            <input type="tel" id="telefon" name="telefon" pattern="[0-9]{9}" placeholder="Exemple: 612345678">

            <label for="web">Pàgina web personal (opcional)</label>
            <input type="url" id="web" name="web" placeholder="https://exemple.com">
        </fieldset>

        <!-- Informació sobre l'esdeveniment -->
        <fieldset>
            <legend>Detalls de l'Esdeveniment</legend>

            <label for="data-naixement">Data de naixement *</label>
            <input type="date" id="data-naixement" name="data-naixement" min="1900-01-01" max="2025-12-31" required>

            <label for="hora-arribada">Hora prevista d'arribada</label>
            <input type="time" id="hora-arribada" name="hora-arribada">

            <label for="preferencies">Color de preferència</label>
            <input type="color" id="preferencies" name="preferencies" value="#0000ff">

            <label for="curs">Selecciona el curs d'interès *</label>
            <select id="curs" name="curs" required>
                <option value="">-- Tria un curs --</option>
                <option value="programacio">Programació Avançada</option>
                <option value="disseny">Disseny d'Interfaces</option>
                <option value="ciberseguretat">Ciberseguretat</option>
            </select>

            <label for="nivell">Nivell d'interès en el curs:</label>
            <input type="range" id="nivell" name="nivell" min="0" max="10" step="1" value="5">
        </fieldset>

        <!-- Fitxers adjunts -->
        <fieldset>
            <legend>Fitxers Adjuntats</legend>

            <label for="cv">Puja el teu CV (PDF o DOCX)</label>
            <input type="file" id="cv" name="cv" accept=".pdf,.docx">

            <label for="imatge">Foto de perfil (opcional)</label>
            <input type="file" id="imatge" name="imatge" accept=".jpg,.png,.jpeg">
        </fieldset>

        <!-- Botons -->
        <button type="submit">Enviar Formulari</button>
        <button type="reset">Restablir Formulari</button>
    </form>

</body>

</html>
```

## Generació dinàmica de formularis

Un dels usos habituals de javascript és la generació dinàmica de formularis, generalment, en conjucció amb altres tècniques com AJAX. Anem a veure, a mode introductori, un exemple de creació de dos elements de tipus select de forma dinàmica.

L'exemple consistirà en un JSON amb dos components corresponents al primer i segon curs d'un cicle formatiu, i cadascun d'ells amb una llista de mòduls del curs. El que farem serà construir dinàmicament dos selects: el primer amb els mòduls, i el segon, que modificarà el seu contingut després de seleccionar el curs, mostrant els mòduls.

```js
<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generació Dinàmica de Formularis</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        select {
            margin: 10px 0;
            padding: 5px;
        }
    </style>
</head>
<body>

    <h1>Generació Dinàmica de Formularis</h1>
    <form id="formulari-moduls">
        <!-- Els selects es generaran dinàmicament aquí -->
    </form>

    <script>
        // Objecte amb els cursos i mòduls
        const cursos = {
            DAM1: ["PRG", "BD", "SI", "LMI", "EDD", "IPO", "ANG", "PI"],
            DAM2: ["AD", "DI", "PSP", "PMDM", "SGI", "IPO2", "SSP", "DSP","PI"]
        };

        // Funció per generar un <select> amb opcions
        function crearSelect(id, opcions) {
            const select = document.createElement("select");
            select.id = id;
            select.name = id;

            // Opció inicial per defecte
            const optDefecte = document.createElement("option");
            optDefecte.value = "";
            optDefecte.textContent = `-- Selecciona una opció --`;
            select.appendChild(optDefecte);

            // Crear opcions a partir del vector proporcionat
            opcions.forEach(opcio => {
                const option = document.createElement("option");
                option.value = opcio;
                option.textContent = opcio;
                select.appendChild(option);
            });

            return select;
        }

        // Funció per omplir els mòduls segons el curs seleccionat
        function omplirModuls(cursSeleccionat) {
            const selectModuls = document.getElementById("modul");

            // Neteja el <select> de mòduls
            selectModuls.innerHTML = "";

            if (cursSeleccionat && cursos[cursSeleccionat]) {
                cursos[cursSeleccionat].forEach(modul => {
                    const option = document.createElement("option");
                    option.value = modul;
                    option.textContent = modul;
                    selectModuls.appendChild(option);
                });
            }
        }

        // Generar els selects al formulari
        function generarFormulari() {
            const formulari = document.getElementById("formulari-moduls");

            // Crear el <select> de cursos
            const selectCursos = crearSelect("curs", Object.keys(cursos));
            formulari.appendChild(selectCursos);

            // Crear un <select> buit per als mòduls
            const selectModuls = crearSelect("modul", []);
            formulari.appendChild(selectModuls);

            // Associar esdeveniment per actualitzar els mòduls segons el curs seleccionat
            selectCursos.addEventListener("change", (event) => {
                const cursSeleccionat = event.target.value;
                omplirModuls(cursSeleccionat);
            });
        }

        // Inicialitzar la generació del formulari quan es carregue la pàgina
        document.addEventListener("DOMContentLoaded", generarFormulari);
    </script>
</body>
</html>
```
